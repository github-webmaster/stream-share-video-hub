# docker-compose-template.yml
# =============================================================================
# TEMPLATE FOR CREATING NEW DEPLOYMENT INSTANCES
# =============================================================================
# 
# To create a new deployment (e.g., docker-compose-alt4.yml):
# 1. Copy this file: copy docker-compose-template.yml docker-compose-alt4.yml
# 2. Find and replace these placeholders:
#    - {{INSTANCE}}  -> 5 (e.g., db5, api5, frontend5)
#    - {{DB_PORT}}   -> 5437 (incrementing from 5432)
#    - {{API_PORT}}  -> 8085 (incrementing from 8081)
#    - {{FE_PORT}}   -> 4004 (incrementing from 4000)
# 3. Deploy: docker compose -f docker-compose-alt4.yml up -d --build
#
# CRITICAL REQUIREMENTS (DO NOT CHANGE):
# - DATABASE_URL must use postgres:postgres (matches docker/.env)
# - CORS_ORIGIN must include the frontend port
# - Database healthcheck ensures API waits for DB
# =============================================================================

services:
  db{{INSTANCE}}:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - ./docker/.env
    volumes:
      - db{{INSTANCE}}_data:/var/lib/postgresql/data
      - ./docker/initdb:/docker-entrypoint-initdb.d:ro
    ports:
      - "{{DB_PORT}}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d streamshare"]
      interval: 5s
      timeout: 5s
      retries: 5

  api{{INSTANCE}}:
    build:
      context: ./server
    restart: unless-stopped
    depends_on:
      db{{INSTANCE}}:
        condition: service_healthy
    env_file:
      - ./docker/.env
    environment:
      PORT: {{API_PORT}}
      # CRITICAL: Must use postgres:postgres - this matches POSTGRES_USER/PASSWORD in docker/.env
      # DO NOT use streamshare:CHANGE_ME or any other credentials!
      DATABASE_URL: postgres://postgres:postgres@db{{INSTANCE}}:5432/streamshare
      STORAGE_PATH: /data/videos
      # CORS: Not needed - defaults to allow all origins for local dev
      # For production, set: CORS_ORIGIN: https://yourdomain.com
    volumes:
      - ./data/videos:/data/videos
    ports:
      - "{{API_PORT}}:{{API_PORT}}"

  frontend{{INSTANCE}}:
    build:
      context: .
      dockerfile: ./docker/frontend.Dockerfile
      args:
        VITE_API_URL: http://localhost:{{API_PORT}}
        VITE_MEDIA_URL: /assets/optimized
    restart: unless-stopped
    depends_on:
      - api{{INSTANCE}}
    ports:
      - "{{FE_PORT}}:80"

volumes:
  db{{INSTANCE}}_data:
